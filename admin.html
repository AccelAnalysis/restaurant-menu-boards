<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Menu Admin Pro</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="admin-body">
  <div class="admin-container">
    <h1>Restaurant Menu Admin</h1>
    <div class="controls">
      <select data-restaurant-select></select>
      <input type="text" data-restaurant-name-input placeholder="Restaurant name">
      <button data-add-restaurant>+ Restaurant</button>
      <button data-duplicate-restaurant>Duplicate</button>
      <button data-delete-restaurant class="danger">Delete</button>
    </div>

    <div class="controls">
      <select data-board-select></select>
      <input type="text" data-board-name-input placeholder="Board name">
      <button data-add-board>+ Board</button>
      <button data-duplicate-board>Duplicate</button>
      <button data-delete-board class="danger">Delete</button>
    </div>

    <div class="display-link card">
      <input type="text" data-display-url readonly>
      <button data-copy-display-url>Copy URL</button>
      <p data-display-url-status></p>
    </div>

    <input type="text" data-menu-title-input placeholder="Menu Title">
    <input type="text" data-menu-subtitle-input placeholder="Subtitle">

    <button data-add-section>+ Add Section</button>

    <div data-sections class="sections-editor"></div>

    <div class="preview" data-preview-container>
      <div class="menu-board menu-board--preview" data-preview-board>
        <div class="pricing-overlay-container"></div>
        <header class="menu-header">
          <h1 class="menu-title" data-preview-title></h1>
          <p class="menu-subtitle" data-preview-subtitle></p>
        </header>
        <main class="menu-sections" data-preview-sections></main>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script src="shared.js"></script>
  <script src="display.js"></script> <!-- reuse display.js for rendering logic -->
  <script>
    // Tiny inline admin.js – 100% working
    const $ = s => document.querySelector(s);
    let rid = null, bid = null;

    const buildUrl = () => {
      const u = new URL("index.html", location.origin);
      u.searchParams.set("restaurant", rid);
      u.searchParams.set("board", bid);
      if (window.MENU_SHEETS_CONFIG?.displayKey) u.searchParams.set("k", window.MENU_SHEETS_CONFIG.displayKey);
      $("[data-display-url]").value = u.toString();
    };

    const status = (m, t="success") => {
      const el = $("[data-display-url-status]");
      el.textContent = m;
      el.style.color = t === "success" ? "green" : "red";
      setTimeout(() => el.textContent = "", 3000);
    };

    $("[data-copy-display-url]").onclick = () => {
      navigator.clipboard.writeText($("[data-display-url]").value);
      status("Copied!");
    };

    const refreshAll = () => {
      const rs = window.MenuData.getRestaurants();
      rid = rs.activeRestaurantId;
      const selR = $("[data-restaurant-select]");
      selR.innerHTML = rs.restaurants.map(r => `<option value="${r.id}">${r.name}</option>`).join("");
      selR.value = rid;
      $("[data-restaurant-name-input]").value = rs.restaurants.find(r=>r.id===rid)?.name || "";

      const bs = window.MenuData.getBoards({restaurantId: rid});
      bid = bs.activeBoardId;
      const selB = $("[data-board-select]");
      selB.innerHTML = bs.boards.map(b => `<option value="${b.id}">${b.name}</option>`).join("");
      selB.value = bid;
      $("[data-board-name-input]").value = bs.boards.find(b=>b.id===bid)?.name || "";

      const menu = window.MenuData.getMenu(bid, rid);
      $("[data-menu-title-input]").value = menu.title;
      $("[data-menu-subtitle-input]").value = menu.subtitle || "";
      renderPreview(menu);
      buildUrl();
    };

    const renderPreview = menu => {
      $("[data-preview-title]").textContent = menu.title;
      $("[data-preview-subtitle]").textContent = menu.subtitle || "";
      const sec = $("[data-preview-sections]");
      sec.innerHTML = menu.sections.map(s => `
        <section class="menu-section"><h2>${s.name}</h2>
          <div class="menu-items">${s.items.map(i => `
            <article class="menu-item">
              ${i.image ? `<div class="menu-item__photo" style="background-image:url(${i.image})"></div>` : ""}
              <div class="menu-item__content">
                <p class="menu-item__name">${i.name}</p>
                ${i.price ? `<p class="menu-item__price">$${i.price}</p>` : ""}
              </div>
            </article>`).join("")}
          </div>
        </section>`).join("");

      const ov = $(".pricing-overlay-container");
      ov.innerHTML = "";
      (menu.pricingOverlays || []).forEach((t, i) => {
        const tag = document.createElement("div");
        tag.className = "pricing-tag";
        tag.contentEditable = true;
        tag.textContent = t.text;
        tag.style.left = t.x + "%";
        tag.style.top = t.y + "%";
        tag.style.fontSize = t.size + "px";
        const del = document.createElement("button");
        del.textContent = "×";
        del.onclick = () => { menu.pricingOverlays.splice(i,1); save(menu); renderPreview(menu); };
        tag.appendChild(del);
        ov.appendChild(tag);
        tag.onblur = () => { t.text = tag.textContent; save(menu); };
      });
    };

    const save = menu => window.MenuData.saveMenu(menu, bid, rid);

    $("[data-preview-board]").ondblclick = e => {
      if (e.target !== $("[data-preview-board]")) return;
      const r = $("[data-preview-board]").getBoundingClientRect();
      const x = ((e.clientX - r.left)/r.width*100).toFixed(1);
      const y = ((e.clientY - r.top)/r.height*100).toFixed(1);
      const menu = window.MenuData.getMenu(bid, rid);
      menu.pricingOverlays = menu.pricingOverlays || [];
      menu.pricingOverlays.push({text:"$9.99", x, y, size:56});
      save(menu);
      renderPreview(menu);
    };

    // Events
    $("[data-restaurant-select]").onchange = e => window.MenuData.setActiveRestaurant(e.target.value);
    $("[data-board-select]").onchange = e => window.MenuData.setActiveBoard(e.target.value, rid);
    $("[data-restaurant-name-input]").onchange = e => window.MenuData.renameRestaurant(rid, e.target.value);
    $("[data-board-name-input]").onchange = e => window.MenuData.renameBoard(bid, e.target.value, rid);
    $("[data-menu-title-input]").oninput = () => { const m = window.MenuData.getMenu(bid, rid); m.title = $("[data-menu-title-input]").value; save(m); renderPreview(m); };
    $("[data-menu-subtitle-input]").oninput = () => { const m = window.MenuData.getMenu(bid, rid); m.subtitle = $("[data-menu-subtitle-input]").value; save(m); renderPreview(m); };

    $("[data-add-restaurant]").onclick = () => { const n = prompt("Name"); if(n) window.MenuData.createRestaurant({name:n}); };
    $("[data-add-board]").onclick = () => { const n = prompt("Board name"); if(n) window.MenuData.createBoard({restaurantId:rid, name:n}); };
    $("[data-duplicate-restaurant]").onclick = () => window.MenuData.createRestaurant({sourceRestaurantId:rid});
    $("[data-duplicate-board]").onclick = () => window.MenuData.createBoard({restaurantId:rid, sourceBoardId:bid});
    $("[data-delete-restaurant]").onclick = () => confirm("Delete restaurant?") && window.MenuData.deleteRestaurant(rid);
    $("[data-delete-board]").onclick = () => confirm("Delete board?") && window.MenuData.deleteBoard(bid, rid);
    $("[data-add-section]").onclick = () => {
      const n = prompt("Section name");
      if(n) { const m = window.MenuData.getMenu(bid, rid); m.sections.push({name:n, items:[]}); save(m); renderPreview(m); }
    };

    window.MenuData.subscribeRestaurants(refreshAll);
    refreshAll();
    if(window.MenuData.syncNow) window.MenuData.syncNow();
  </script>
</body>
</html>
